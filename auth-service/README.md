# Authentication Service

The authentication service is built to use application authentication as well as user authentication

To connect the service to the frontend clients, follow these steps.

1. Request to obtain the API key from the system administrator. The API key is a unique identifier for your application and is used to authenticate requests to the backend services.
- The API key is generated by the system administrator and is unique to each application.
- The API key is stored in the database and is used to authenticate requests to the backend services.
- The application is assigned permissions based on the needs of the application.
- In your request, include the following information:
  - Application name
  - Description of the application
  - Purpose of the application
  - Any specific main resources required (e.g., health-services, property-service) with their permissions (e.g., read, write, admin) based on the user permission matrix
  - Note: The matrix is based on the resource, so in your resource, only specify the main resource and permissions. 
  - Once approved, the system administrator will generate the API key and send it to you. Store this key securely, as it will be used to authenticate your application with the backend services.

2. When creating users, permissions are assigned based on the user types passed during creation. The data required currently for creating a user is as follows:

```json
{
  "email": "user@exmaple.com",
  "password": "Test_1234",
  "first_name": "John",
  "last_name": "Doe",
  "home_address": "123 Main St, City, Country",
  "user_type_names": ["resident"]
}
```

- The ```user_type_names``` field must be list of values from the user type matrix. The user type matrix is a list of all the user types in the system and their permissions.

2. All user tokens are generated by the authentication service. The user tokens are used to authenticate users with the backend services.
- User tokens are generated when logging in and returned as follows:
```json
{
  "expiry": "",
  "token": "abcdefghijklmnopqrstuvwxyz",
  "user": {
    "email": "user@exmaple.com"
  }
}
```
- When a token expires, the user must log in again to obtain a new token.

- To login the request body should be as follows:

```json
{
    "username": "test@example.com",
    "password": "Test_1234"
}
```

2. Once the application is created, all requests to the backend must contain the following headers

```json
"X-API-KEY": "the secret api key",
"X-RESOURCE": "the main resource",
"X-SUB-RESOURCE": "the sub resource",
"X-METHOD": "the method to be used",
"Authorization": "Token <user_token>"
``` 


When making calls to the backend and authenticating calls, each service should redirect the call to the authentication server to validate it before proceeding. 

Here is an example of how you can authenticate a call:

```python
    def authenticate(self, request):
        # Extract required headers
        api_key = request.headers.get('x-api-key')
        user_token = self._extract_user_token(request)
        resource = request.headers.get('x-resource')
        sub_resource = request.headers.get('x-sub-resource')

        auth_results = {
            'application': None,
            'user': None
        }

        # First verify application permissions
        if api_key and resource:
            try:
                app_auth = PermissionValidator.check_application_permission(api_key, resource)
                auth_results['application'] = app_auth
            except AuthenticationFailed as e:
               
                if not user_token:
                    raise  # If no user token provided, fail completely

        # Then verify user permissions if token exists
        if user_token and resource and sub_resource:
            try:
                user_auth = PermissionValidator.check_user_permission(
                    user_token, api_key, resource, sub_resource
                )
                auth_results['user'] = user_auth
            except AuthenticationFailed as e:
                if not auth_results.get('application'):
                    raise  # Fail if neither application nor user auth succeeded

        # At least one authentication method must succeed
        if not auth_results['application'] and not auth_results['user']:
            raise AuthenticationFailed('Neither application nor user authentication succeeded')

        # Return auth tuple (user, auth_data)
        user = self._create_user_object(auth_results)
        return (user, None)
```


# Documentation

The documentation for all authentication endpoints is available at the ```api/auth/schema/redoc``` endpoint.

# User Permission Matrix

This section outlines the permissions granted to different user types for various resources in the system, organized by main services.

## Legend
- **read**: Can view the resource
- **write**: Can create/modify the resource
- **admin**: Has full administrative control over the resource
- *(anonymous)*: Resource allows anonymous access

## Resource Categories

### 1. Calendar Services
#### Sub-resources:
- **events** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Event Organizer: read, write
  - Business Support: read (via fetch-events)
- **comments** *(anonymous)*
  - Resident: read, write

### 2. Activities Services
#### Sub-resources:
- **activities** *(anonymous)*
  - Resident: read
  - Tourist: read

### 3. Places Services
#### Sub-resources:
- **fetch-places** *(anonymous)*
  - Resident: read
  - Tourist: read
- **modify-places**
  - (No roles currently have permissions)
- **review-places**
  - Resident: read, write

### 4. Accommodation Services
#### Sub-resources:
- **fetch-accommodation** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Accommodation Provider: read
- **modify-accommodation**
  - (No roles currently have permissions)
- **review-accommodation**
  - Resident: read, write
  - Accommodation Provider: read, write, admin

### 5. Restaurants Services
#### Sub-resources:
- **fetch-restaurants** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Restaurant Owner: read
- **review-restaurants**
  - Resident: read, write
  - Restaurant Owner: read, write, admin

### 6. Mapping Services
#### Sub-resources:
- **fetch-mapping** *(anonymous)*
  - Resident: read
  - Tourist: read

### 7. Weather Services
#### Sub-resources:
- **fetch-weather** *(anonymous)*
  - Resident: read
  - Tourist: read

### 8. Property Services
#### Sub-resources:
- **property** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Property Developer: read, write
  - Planning Department: read
  - Building Inspector: read
- **property-admin**
  - Property Developer: read
  - Planning Department: read, write, admin
  - Building Inspector: read, write, admin

### 9. Health Services
#### Sub-resources:
- **environment-health** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Environmental Officer: read, write, admin
  - Health Services: read, write, admin
- **modify-cemetery-health**
  - Funeral Home: read, write
  - Health Services: read, write, admin
- **fetch-cemetery-health** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Funeral Home: read
  - Health Services: read
- **complaint-health**
  - Resident: read, write
  - Environmental Officer: read, write, admin
  - Health Services: read, write, admin

### 10. Community Services
#### Sub-resources:
- **books** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Library Staff: read, write, admin
  - Community Services: read, write, admin
- **borrow**
  - Resident: read, write
  - Library Staff: read, write, admin
  - Community Services: read, write, admin

### 11. Economic Services
#### Sub-resources:
- **register-business** *(anonymous)*
  - Resident: read, write
  - Business Owner: read, write
  - Business Support: read, write, admin
- **modify-attraction**
  - Business Support: read, write, admin
- **fetch-attraction** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Business Support: read
- **modify-events**
  - Event Organizer: read, write
  - Business Support: read, write, admin
- **fetch-events** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Business Support: read

### 12. Safety Services
#### Sub-resources:
- **report-incident**
  - Resident: read, write
  - Fire Department: read, write, admin
  - Law Enforcement: read, write, admin
- **status-incident** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Fire Department: read, write, admin
  - Law Enforcement: read, write, admin

### 13. Waste Services
#### Sub-resources:
- **fetch-schedule** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Waste Management: read
- **modify-schedule**
  - Waste Management: read, write, admin
- **report-pickup**
  - Resident: read, write
  - Waste Management: read, write, admin
- **fetch-recycling** *(anonymous)*
  - Resident: read
  - Tourist: read
  - Waste Management: read
- **modify-recycling**
  - Waste Management: read, write, admin
- **bin** *(anonymous)*
  - Resident: read, write
  - Waste Management: read, write, admin

### 14. Citizen Portal
#### Sub-resources:
- **auth** *(anonymous)*
  - All roles: read, write


